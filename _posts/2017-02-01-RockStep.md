---
layout: post
title:  "Using Power BI to provide reports for research labs with RockStep"
author: "Heather Shapiro, James Sturtevant"
author-link: "#"
#author-image: "{{ site.baseurl }}/images/authors/photo.jpg"
date:   2017-02-01 
categories: [Power BI Embedded]
color: "blue"
#image: "{{ site.baseurl }}/images/Athena/AthenaWebsite.PNG" #should be ~350px tall
excerpt: Microsoft teamed up with RockStep to deliver realtime IoT data to their labs through Power BI Embedded.
verticals: [Life Sciences, Facility Management]
language: English
---

Microsoft joined RockStep to create a Power BI Embedded solution, which gives access IoT data analyses in realtime to reduce operating and maintenance costs for their clinical trial customers. Research facilities have thousands of housing units that need to be checked on a regular schedule to ensure the conditions are within compliance. RockStep is teaming up with the University of Michigan to run a pilot IoT program that monitors key environmental measurements in real time and will proactively alert technicians when conditions reach a threshold range. By reducing the number of visits to each unit they can cut maintenance and operating costs and improve the overall health of animals.


Core team: 
- [Abigail Ames](https://twitter.com/rocksteptech) – Director of Technology, RockStep
- [Keith Sheppard](https://twitter.com/keithsheppard) – Lead Developer, RockStep
- [James Sturtevant](https://twitter.com/Aspenwilder) – Senior Technical Evangelist, Microsoft
- [Heather Shapiro](https://twitter.com/microheather))- Technical Evangelist, Microsoft

![picture of team working](/images/rockstep/rs-pbie-working-session.jpg)

## Customer profile ##

[RockStep Solutions](https://www.rockstepsolutions.com) creates world-class scientific data management tools for research. Its innovative software system [Climb](https://www.rockstepsolutions.com/features/introducing-climb/) is designed to transform and modernize information management in a laboratory setting. The RockStep team's experience comes directly from years of working at the Jackson Laboratory in Bar Harbor, Maine. RockStep's goal is to create software that enables science by leveraging the team's experience working in research laboratories to build software that is easy to learn, usable anywhere, and truly valuable to research.

![rockstep logo](/images/rockstep/rs-logo.png)


## Problem statement ##

RockStep will be deploying around 100 devices to pilot the IoT project, previously supported by James Sturtevant. These devices will be going into several different animal rooms and will continuously collect temperature, ammonia, humidity, noise and light levels. For the pilot, RockStep will only be analyzing these data, but in the future they will layer in experimental data so that the users can look at experimental results in the context of factors such as noise and light levels.  The first goal is to monitor environmental data for the purposes of more accurately determining cage change rates.  Cages must be changed at periodic intervals to keep the levels of ammonia and humidity within FDA regulation values, however cage changes are costly and disruptive to the animals.  So the IoT data will help the technicians in the facility to only change cages when necessary. 
We will be building PowerBI reports for users to view the streaming data from the IoT devices, do real time transformations on the data, do aggregations, create alerts, and store the data.  We are assuming that the stored data will be used for historical analysis as well.

Our goal was to connect to the RockStep data hosted in an Azure SQL Database and integrate the created Power BI reports into their current MClimb application.

## Key Technologies Used 
- [Power Bi Embedded](https://azure.microsoft.com/en-us/services/power-bi-embedded/) 
- [Power Bi Desktop](https://powerbi.microsoft.com/en-us/desktop/) 
- [Azure SQL Database](https://azure.microsoft.com/en-us/services/sql-database/) 
- [ASP.NET MVC](https://www.asp.net/mvc) 
- [Angular 2.0](https://angular.io/)
- [Azure App Services](https://azure.microsoft.com/en-us/services/app-service/)

## Solutions, steps, and delivery ##
RockStep and Microsoft teamed up to create a "proof of concept" that would display their simulated IoT data through embedded Power BI reports in a website running Angular 2.0. The solution was developed over the course of a few days at a hackfest held at the Microsoft office in Burlington, Massachusetts.  

The overall architecture for their IoT Solution is as follows:

![architecture diagram](/images/rockstep/rs-architecture.png)

This solution is the base for wthe data that was passed into the Power BI Embedded Solution Architecture that is seen below:

![pbie-architecture diagram](/images/rockstep/rs-pbie-architecture.jpg)


1. [Connect to RockStep data in Azure Sql DBs](#1-connect-to-athena-data-in-postgresql-dbs-in-azure-iaas).
2. [Build a report using Power BI desktop](#2-create-a-report-in-power-bi-desktop).
3. [Deploy a report to Power BI Embedded in Azure and Upload Reports](#3-set-up-power-bi-embedded-workspace-in-microsoft-azure-and-upload-reports).
4. [Integrate PBIE reports into an ASP.NET MVC web application](#4-embed-report-into-existing-aspnet-mvc-application-and-authorize-users-for-specific-reports).

-----
### 1. Connect to Athena Data in PostgreSQL DBs In Azure IaaS 



### 2. Create a template report in Power BI Desktop


### 3. Set up Power BI Embedded workspace in Microsoft Azure and Upload Reports

By identifying users we were able to efficiently create isolation from reports using workspaces. We created workspaces that would serve reports for Utility companies, Food/Agriculture industries, generic research, and a final one for test/samples.

Here's what it looks like in the dashboard: 
![3 Workspaces for 3 customers](/images/Athena/Workspaces.PNG)

There are several methods to publish a report in a Power BI Embedded workspace:
- Using the one provided in the sample app: [Sample app](https://github.com/Azure-Samples/power-bi-embedded-integrate-report-into-web-app/)
- Using the Power BI command line tool: [Power BI Command Line Tool](https://github.com/Microsoft/PowerBI-Cli)

We used the command line tool to publish our reports in the workspace. Below are steps and screenshots of the process:
- First we had to install [node.js](https://nodejs.org/en/).
- Then we installed a Power BI node.js package using the command prompt: `npm install powerbi-cli -g`

![Install node.js package](/images/Athena/Nodejs-PowerBI.PNG)

- And finally, we used the command "powerbi - import" as listed in the screenshot below to add the Power BI Desktop reports to the Azure Workspace Collection:

![Power BI Command](/images/Athena/Powerbi-nodejs.PNG)

The report was created with a static dataset, rather than direct query, so we did not have to update connection strings the the uploaded dataset. We documented these steps in the PoC Readme for easy replication for Athena. 


### 4. Embed report into existing ASP.NET MVC application and authorize users for specific reports

The application builds off of the sample provided by the Power Bi embedded team found here: [Embed Sample](https://github.com/Azure-Samples/power-bi-embedded-integrate-report-into-web-app)

We began by setting up a new PowerBIController within the existing web application.  Through this controller we are able to limit access to the RitterIM internal report.  In code, we create an embed token using:

`var embedToken = PowerBIToken.CreateReportEmbedToken(this.workspaceCollection, this.workspaceId, report.Id);` 

This allows us to view the embedded report within the existing website:

![Athena Power Bi Embedded](/images/Athena/ReportPage.PNG)

With this first report integrated we needed to expand the web application to allow registration and login capabilities. 
Then we needed to grant specific users access to specific reports.


In order to give users access to the app, we added in the Identity authentication framework to allow users to login. 

We set up a SQL database with user information created from the Identity package. When users sign up on the website, they are asked which customer profile they fit better, ie. are they part of a Utility company, Food/Agriculture industru,  or doing generic research.

Depending on their selection, we only allow users to view this specific report. This is done by only displaying a report that matches the category that they select. Through Identity, the user is associated with the category. This category is then compared to the report names, and only the reports in the workspace that contain that category will be displayed.

### 5. Use Azure SQL and Azure Web Apps to deploy application

Now that we have a working application we need to deploy the web app to Azure with staging capabilities for easy testing and deployment. 

We used Azure Web Apps with a SQL Server instance to support the user authentication/login. 

To make ongoing development easy we've created two Databases one for testing and one for production. 
Accordingly we created a staging slot for the application that connects to the test database via a Slot Connection string: 

Here's what this looks like in the Azure Dashboard:  

![Athena Web App Staging](/images/Athena/stagingslots.PNG)

This staging slot is connected to a private Git repository, so as changes are committed the developer is able to check them in staging before hitting swap to move the new application into production. 

##  End customer example  ##

[![Athena Intelligence Dashboard Tour](/images/Athena/AthenaDashboardVideo.PNG)](https://www.youtube.com/watch?v=YKUhFQRRwaM)

## General lessons ##

### Staging slots in Azure - connection strings ###

### Authentication using Identity ###

It is unneccessary for all of Athena's customers to see all of the reports in the workspace collection as many of them are from different industries. Since we have separate reports for each industry, row level security was not applicable in this scenario. Instead, we restricted what users could see by adding in authentication through extra user fields in Identity. During the registration process, users are asked which industry they are part of. As a result, as seen in the code below, we limit which of the 4 reports the user sees based on their industry genre selection when they signed up. If the user is not logged in, they cannot see any reports. If they are signed in, they can only see the reports that match their genre name that they selected.

![Athena Dashboard Selection](/images/Athena/DeterminingShownReports.PNG)

### County data issues with reports ###

### Visual studio nuget versioning ###
We ran into some issues with Visual Studio nugest versioning with the Microsoft Power BI SDK. We followed [this](https://microsoft.github.io/techcasestudies/power%20bi%20embedded/2016/11/21/surespot.html#general-lessons) guide from Microsoft's, Paul Decarlo, on what was necessary to get the SDK working and the app to run. 

### Creating a SQL database that deploys to azure ###

We started with a blank dataset provided by the Identity framework 




## Additional resources ##

